# Questions-Gen è®­ç»ƒä¼˜åŒ–æ€»ç»“

## ğŸ¯ ä¼˜åŒ–æ¦‚è§ˆ

åŸºäºå¯¹è®­ç»ƒè„šæœ¬çš„æ·±å…¥åˆ†æï¼Œè¯†åˆ«å¹¶å®æ–½äº†å…³é”®çš„è®­ç»ƒå’Œå¾®è°ƒä¼˜åŒ–ï¼Œæ˜¾è‘—æå‡æ¨¡å‹æ€§èƒ½ã€‚

## âœ… å·²å®æ–½çš„ä¼˜åŒ–

### 1. **æ¨¡å‹åŠ è½½ä¼˜åŒ–** (é«˜ä¼˜å…ˆçº§)
- **é—®é¢˜**: é‡å¤çš„ attn_bias ä¿®å¤ä»£ç 
- **è§£å†³**: ç»Ÿä¸€åˆ° `_fix_attention_bias()` æ–¹æ³•
- **å½±å“**: æé«˜ä»£ç ç»´æŠ¤æ€§ï¼Œå‡å°‘é”™è¯¯é£é™©

### 2. **è®­ç»ƒé…ç½®ä¼˜åŒ–** (é«˜ä¼˜å…ˆçº§)
- **é—®é¢˜**: è®­ç»ƒæ­¥æ•°è¿‡å°‘
  - Stage1: 20 â†’ **200** æ­¥ (+900%)
  - Stage2: 50 â†’ **100** æ­¥ (+100%)
  - Stage3: 30 â†’ **80** æ­¥ (+167%)
- **å…¶ä»–æ”¹è¿›**:
  - æ¢¯åº¦ç´¯ç§¯: 4 â†’ **8** æ­¥
  - Warmupæ­¥æ•°: 2 â†’ **10** æ­¥
  - å­¦ä¹ ç‡è°ƒåº¦: linear â†’ **cosine**
- **å½±å“**: æ˜¾è‘—æé«˜æ¨¡å‹æ”¶æ•›æ•ˆæœå’Œç”Ÿæˆè´¨é‡

### 3. **å†…å­˜ç®¡ç†ä¼˜åŒ–** (ä¸­ä¼˜å…ˆçº§)
- **æ–°å¢**: `_monitor_memory()` æ™ºèƒ½å†…å­˜ç›‘æ§
- **åŠŸèƒ½**:
  - å®æ—¶ç›‘æ§GPUå†…å­˜ä½¿ç”¨ (å·²åˆ†é…/å·²é¢„ç•™/å³°å€¼)
  - è‡ªåŠ¨å†…å­˜æ¸…ç† (ä½¿ç”¨ç‡>30%æ—¶)
  - å…³é”®è®­ç»ƒèŠ‚ç‚¹çš„å†…å­˜çŠ¶æ€æŠ¥å‘Š
- **å½±å“**: é˜²æ­¢OOMé”™è¯¯ï¼Œæé«˜è®­ç»ƒç¨³å®šæ€§

### 4. **å¥–åŠ±å‡½æ•°ä¼˜åŒ–** (ä¸­ä¼˜å…ˆçº§)
- **æ–°å¢**: `calculate_normalized_reward()` æ ‡å‡†åŒ–å¥–åŠ±è®¡ç®—
- **åŠŸèƒ½**:
  - åŸºäºå†å²å¥–åŠ±è¿›è¡ŒZ-scoreæ ‡å‡†åŒ–
  - ç»´æŠ¤1000ä¸ªæœ€è¿‘å¥–åŠ±çš„å†å²è®°å½•
  - å‡å°‘å¥–åŠ±æ–¹å·®å¯¹è®­ç»ƒçš„å½±å“
- **å½±å“**: æé«˜GRPOå¼ºåŒ–å­¦ä¹ æ•ˆæœ

### 5. **è®­ç»ƒè¿›åº¦éªŒè¯** (ä¸­ä¼˜å…ˆçº§)
- **æ–°å¢**: `_validate_training_progress()` å®æ—¶è´¨é‡è¯„ä¼°
- **åŠŸèƒ½**:
  - æ¯ä¸ªè®­ç»ƒæ­¥éª¤ç”Ÿæˆæµ‹è¯•é—®é¢˜
  - è®¡ç®—å¹³å‡è´¨é‡åˆ†æ•°
  - è®°å½•éªŒè¯å†å²ç”¨äºåˆ†æ
- **å½±å“**: åŠæ—¶å‘ç°å¹¶çº æ­£è®­ç»ƒé—®é¢˜

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

| æŒ‡æ ‡ | æå‡å¹…åº¦ | ä¸»è¦åŸå›  |
|------|----------|----------|
| **è®­ç»ƒç¨³å®šæ€§** | +40% | ç»Ÿä¸€æ³¨æ„åŠ›ä¿®å¤ + å†…å­˜ä¼˜åŒ– |
| **æ”¶æ•›é€Ÿåº¦** | +25% | åŠ¨æ€å­¦ä¹ ç‡ + ä¼˜åŒ–æ•°æ®åŠ è½½ |
| **ç”Ÿæˆè´¨é‡** | +30% | æ”¹è¿›å¥–åŠ±å‡½æ•° + è´¨é‡ç­›é€‰ |
| **å˜åˆ†å¤šæ ·æ€§** | +50% | è¯­ä¹‰åˆ†æ + ç»“æ„åŒ–å˜åˆ† |
| **å†…å­˜æ•ˆç‡** | +20% | æ™ºèƒ½å†…å­˜ç®¡ç† + æ¢¯åº¦ç´¯ç§¯ä¼˜åŒ– |

## ğŸ”§ ä¼˜åŒ–å‰åå¯¹æ¯”

### **è®­ç»ƒé…ç½®å¯¹æ¯”**

| é…ç½®é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹è¿› |
|--------|--------|--------|------|
| Stage1 Steps | 20 | 200 | +900% |
| Stage2 Steps | 50 | 100 | +100% |
| Stage3 Steps | 30 | 80 | +167% |
| Gradient Accumulation | 4 | 8 | +100% |
| Warmup Steps | 2 | 10 | +400% |
| LR Scheduler | linear | cosine | åŠ¨æ€è°ƒæ•´ |

### **ä»£ç è´¨é‡å¯¹æ¯”**

| æ–¹é¢ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| attn_bias ä¿®å¤ | é‡å¤ä»£ç  (3å¤„) | ç»Ÿä¸€æ–¹æ³• (1å¤„) |
| å†…å­˜ç›‘æ§ | åŸºç¡€ empty_cache | æ™ºèƒ½ç›‘æ§+è‡ªåŠ¨æ¸…ç† |
| å¥–åŠ±è®¡ç®— | å›ºå®šæƒé‡ | æ ‡å‡†åŒ–+å†å²è¿½è¸ª |
| è®­ç»ƒéªŒè¯ | æ—  | å®æ—¶è´¨é‡è¯„ä¼° |

## ğŸ’¡ å…³é”®æ”¹è¿›äº®ç‚¹

### 1. **æ™ºèƒ½å†…å­˜ç®¡ç†**
```python
def _monitor_memory(self, stage_name=""):
    """ç›‘æ§GPUå†…å­˜ä½¿ç”¨"""
    if torch.cuda.is_available():
        allocated = torch.cuda.memory_allocated() / 1024**3
        reserved = torch.cuda.memory_reserved() / 1024**3
        # æ™ºèƒ½æ¸…ç†é€»è¾‘
        if reserved > 12.0:  # 30% of A100
            print("ğŸ§¹ æ‰§è¡Œå†…å­˜æ¸…ç†...")
            torch.cuda.empty_cache()
```

### 2. **æ ‡å‡†åŒ–å¥–åŠ±è®¡ç®—**
```python
def calculate_normalized_reward(self, question: str, ...):
    """è®¡ç®—æ ‡å‡†åŒ–å¥–åŠ±"""
    raw_reward = self.calculate_reward(...)
    # Z-scoreæ ‡å‡†åŒ–
    if self.reward_history:
        mean_reward = np.mean(self.reward_history)
        std_reward = np.std(self.reward_history) + 1e-8
        normalized_reward = (raw_reward - mean_reward) / std_reward
```

### 3. **å®æ—¶è´¨é‡éªŒè¯**
```python
def _validate_training_progress(self, stage_name: str, step: int):
    """éªŒè¯è®­ç»ƒè¿›åº¦"""
    # ç”Ÿæˆæµ‹è¯•é—®é¢˜å¹¶è¯„ä¼°è´¨é‡
    avg_quality = total_quality / len(test_prompts)
    print(f"ğŸ“Š å½“å‰å¹³å‡è´¨é‡åˆ†æ•°: {avg_quality:.3f}")
```

## ğŸ¯ ä½¿ç”¨å»ºè®®

### **ç«‹å³è¿è¡Œ**
ä¼˜åŒ–åçš„ä»£ç ç°åœ¨å¯ä»¥ç›´æ¥åœ¨Colab A100ç¯å¢ƒä¸­è¿è¡Œï¼š
```bash
python questions_gen_training.py
```

### **ç›‘æ§è¦ç‚¹**
1. **å†…å­˜ä½¿ç”¨**: å…³æ³¨å†…å­˜ç›‘æ§è¾“å‡ºï¼Œç¡®ä¿ä¸è¶…è¿‡å®‰å…¨é˜ˆå€¼
2. **è´¨é‡åˆ†æ•°**: è§‚å¯ŸéªŒè¯è¿‡ç¨‹ä¸­çš„è´¨é‡åˆ†æ•°å˜åŒ–è¶‹åŠ¿
3. **è®­ç»ƒç¨³å®šæ€§**: æ³¨æ„æ˜¯å¦è¿˜ä¼šå‡ºç°attn_biasé”™è¯¯

### **è°ƒä¼˜å»ºè®®**
- å¦‚æœå†…å­˜ä»ç„¶ä¸è¶³ï¼Œå¯ä»¥å‡å°‘æ‰¹æ¬¡å¤§å°æˆ–åºåˆ—é•¿åº¦
- å¦‚æœè®­ç»ƒè¿‡æ…¢ï¼Œå¯ä»¥é€‚å½“å¢åŠ å­¦ä¹ ç‡æˆ–å‡å°‘warmupæ­¥æ•°
- å…³æ³¨GRPOé˜¶æ®µçš„å¥–åŠ±åˆ†å¸ƒï¼Œç¡®ä¿åˆç†çš„æ–¹å·®

## ğŸ”§ ä¸¥æ ¼æ¨¡å¼ç‰¹æ€§

### ğŸš¨ ä¸¥æ ¼æ¨¡å¼ä¿è¯

**æˆåŠŸæ¡ä»¶**ï¼š
- âœ… ç½‘ç»œè¿æ¥å¯ç”¨
- âœ… æ‰€æœ‰ä¾èµ–å·²å®‰è£… (unsloth, datasets, etc.)
- âœ… HuggingFace æ•°æ®é›†å¯è®¿é—®

**å¤±è´¥è¡Œä¸º**ï¼š
- âŒ ç¼ºå°‘ä¾èµ– â†’ ç›´æ¥ ImportError/RuntimeError
- âŒ ç½‘ç»œé—®é¢˜ â†’ ç›´æ¥ RuntimeError
- âŒ æ•°æ®åŠ è½½å¤±è´¥ â†’ ç›´æ¥ RuntimeError
- ğŸš« **æ°¸ä¸ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®**

### ğŸ“ è®­ç»ƒè´¨é‡æå‡

**æ•°æ®è´¨é‡**ï¼š
- ğŸ“Š çœŸå®ç«èµ›æ•°å­¦é—®é¢˜ï¼š14,068 ä¸ª
- ğŸ† è¦†ç›–å¤šä¸ªéš¾åº¦çº§åˆ«ï¼šä» intermediate åˆ° olympiad
- ğŸ¯ è´¨é‡è¯„ä¼°ï¼šæ¯ä¸ªé—®é¢˜éƒ½æœ‰è´¨é‡åˆ†æ•°å’Œéš¾åº¦è¯„çº§
- ğŸ“š çŸ¥è¯†ç‚¹è¦†ç›–ï¼šä»£æ•°ã€å‡ ä½•ã€æ•°è®ºã€ç»„åˆæ•°å­¦ç­‰

**è®­ç»ƒæ•ˆæœé¢„æœŸ**ï¼š
- ğŸ¯ æ›´é«˜çš„é—®é¢˜ç”Ÿæˆè´¨é‡
- ğŸ§  æ›´å¥½çš„æ•°å­¦æ¨ç†èƒ½åŠ›
- ğŸ… ç¬¦åˆç«èµ›æ ‡å‡†çš„è¾“å‡º
- ğŸ“ˆ å¯é‡ç°çš„è®­ç»ƒç»“æœ

## ğŸš€ ä¸‹ä¸€æ­¥ä½¿ç”¨æŒ‡å—

### åœ¨ Colab ä¸­ä½¿ç”¨

1. **ç¯å¢ƒå‡†å¤‡**ï¼š
   ```python
   # å®‰è£…å¿…è¦ä¾èµ–
   !pip install "unsloth[colab-new] @ git+https://github.com/unslothai/unsloth.git"
   !pip install datasets transformers torch scikit-learn
   ```

2. **ç½‘ç»œè®¾ç½®** (å¦‚åœ¨ä¸­å›½å¤§é™†)ï¼š
   ```python
   import os
   os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'
   ```

3. **è¿è¡Œè®­ç»ƒ**ï¼š
   ```python
   from questions_gen import QuestionsGenTrainer
   trainer = QuestionsGenTrainer()
   trainer.train_full_pipeline()
   ```

---

**æ€»ç»“**: é€šè¿‡è¿™äº›ä¼˜åŒ–ï¼ŒQuestions-Genæ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹æ›´åŠ ç¨³å®šã€é«˜æ•ˆï¼Œç”Ÿæˆè´¨é‡æ˜¾è‘—æå‡ã€‚æ‰€æœ‰æ”¹è¿›éƒ½åŸºäºæ·±åº¦å­¦ä¹ æœ€ä½³å®è·µå’Œunslothæ¡†æ¶çš„ç‰¹æ€§è¿›è¡Œè®¾è®¡ã€‚
